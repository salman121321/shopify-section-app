{% schema %}
{
  "name": "3D Carousel Pro",
  "target": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "App Dashboard Control"
    },
    {
      "type": "checkbox",
      "id": "use_app_data",
      "label": "Use Data from App Dashboard",
      "default": false,
      "info": "If enabled, content will be pulled from the '3D Carousel Builder' in the App."
    },
    {
      "type": "text",
      "id": "carousel_id",
      "label": "Carousel Group ID",
      "default": "default",
      "info": "Enter the ID of the Carousel Group you created in the App Dashboard (e.g., 'homepage', 'sale'). Default is 'default'."
    },
    {
      "type": "header",
      "content": "Content Source"
    },
    {
      "type": "product_list",
      "id": "product_list",
      "label": "Bulk Product Selection",
      "limit": 12
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection (Fallback)"
    },
    {
      "type": "range",
      "id": "product_limit",
      "min": 5,
      "max": 20,
      "step": 1,
      "label": "Max Products",
      "default": 10
    },
    {
      "type": "paragraph",
      "content": "Custom Image Slides (Display first)"
    },
    {
      "type": "checkbox",
      "id": "slide_1_enable",
      "label": "Enable Custom Slide 1",
      "default": false
    },
    {
      "type": "image_picker",
      "id": "slide_1_image",
      "label": "Slide 1 Image"
    },
    {
      "type": "url",
      "id": "slide_1_link",
      "label": "Slide 1 Link"
    },
    {
      "type": "checkbox",
      "id": "slide_2_enable",
      "label": "Enable Custom Slide 2",
      "default": false
    },
    {
      "type": "image_picker",
      "id": "slide_2_image",
      "label": "Slide 2 Image"
    },
    {
      "type": "url",
      "id": "slide_2_link",
      "label": "Slide 2 Link"
    },
    {
      "type": "checkbox",
      "id": "slide_3_enable",
      "label": "Enable Custom Slide 3",
      "default": false
    },
    {
      "type": "image_picker",
      "id": "slide_3_image",
      "label": "Slide 3 Image"
    },
    {
      "type": "url",
      "id": "slide_3_link",
      "label": "Slide 3 Link"
    },
    {
      "type": "header",
      "content": "Text & Headings"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Products"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Subheading",
      "default": "<p>Check out our latest collection</p>"
    },
    {
      "type": "header",
      "content": "Appearance & Layout"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#a3d5f7"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Text Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Card Background",
      "default": "#ffffff"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full Width",
      "default": true
    },
    {
      "type": "range",
      "id": "section_height",
      "min": 400,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Height",
      "default": 600
    },
    {
      "type": "range",
      "id": "carousel_radius",
      "min": 200,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Carousel Radius",
      "default": 450
    },
    {
      "type": "select",
      "id": "card_style",
      "label": "Card Style",
      "options": [
        { "value": "solid", "label": "Solid" },
        { "value": "glass", "label": "Glassmorphism" },
        { "value": "outlined", "label": "Outlined" }
      ],
      "default": "solid"
    },
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Auto Rotate",
      "default": true
    }
  ]
}
{% endschema %}

{%- style -%}
    .carousel-section-wrapper-{{ section.id }} {
        background-color: {{ section.settings.background_color }};
        height: {{ section.settings.section_height }}px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        {% if section.settings.full_width == false %}
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 20px;
        {% endif %}
    }

    .carousel-content-{{ section.id }} {
        text-align: center;
        z-index: 2;
        margin-bottom: 20px;
        position: absolute;
        top: 20px;
        width: 100%;
        max-width: 1200px;
        padding: 0 20px;
    }

    .carousel-heading-{{ section.id }} {
        color: {{ section.settings.heading_color }};
        font-size: 32px;
        margin: 0 0 10px 0;
    }

    .carousel-subheading-{{ section.id }} {
        color: {{ section.settings.heading_color }};
        font-size: 16px;
        margin: 0;
    }

    .carousel-scene-{{ section.id }} {
        perspective: 1000px;
        width: 280px;
        height: 400px;
        position: relative;
        transform-style: preserve-3d;
    }

    .carousel-card-{{ section.id }} {
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        border-radius: 16px;
        background: {{ section.settings.card_bg_color }};
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: transform 0.5s;
        text-decoration: none;
        
        {% if section.settings.card_style == 'glass' %}
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        {% elsif section.settings.card_style == 'outlined' %}
            background: transparent;
            border: 2px solid {{ section.settings.heading_color }};
        {% endif %}
    }

    .card-image-{{ section.id }} {
        width: 100%;
        height: 60%;
        object-fit: cover;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    
    .card-image-content {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .card-info-{{ section.id }} {
        padding: 15px;
        text-align: center;
        color: {{ section.settings.heading_color }};
    }
{%- endstyle -%}

<div class="carousel-section-wrapper-{{ section.id }}">
    <div class="carousel-content-{{ section.id }}">
        {% if section.settings.heading != blank %}
            <h2 class="carousel-heading-{{ section.id }}">{{ section.settings.heading }}</h2>
        {% endif %}
        {% if section.settings.subheading != blank %}
            <div class="carousel-subheading-{{ section.id }}">{{ section.settings.subheading }}</div>
        {% endif %}
    </div>

    <div class="carousel-scene-{{ section.id }}" id="scene-{{ section.id }}">
        {%- assign total_items = 0 -%}
        {%- assign app_data_active = false -%}
        
        {%- if section.settings.use_app_data and app.metafields.shopi_section.carousel_data != blank -%}
             {%- assign app_data_active = true -%}
             {%- assign carousel_id = section.settings.carousel_id | default: "default" -%}
             {%- assign app_slides = app.metafields.shopi_section.carousel_data.value[carousel_id] -%}
             
             {%- if app_slides == blank -%}
                <!-- Fallback to default if specified ID is empty or invalid -->
                {%- assign app_slides = app.metafields.shopi_section.carousel_data.value['default'] -%}
             {%- endif -%}

             {%- if app_slides != blank -%}
                {%- assign total_items = app_slides.size -%}
             {%- endif -%}
        {%- endif -%}

        {%- if app_data_active == false or total_items == 0 -%}
             <!-- If App Data is disabled or empty, use Theme Settings -->
             {%- assign app_data_active = false -%}
             
            {%- if section.settings.product_list != blank -%}
                 {%- assign total_items = total_items | plus: section.settings.product_list.count -%}
            {%- elsif section.settings.collection != blank -%}
                 {%- assign total_items = total_items | plus: section.settings.collection.products_count -%}
            {%- endif -%}

            {%- if section.settings.slide_1_enable -%}{% assign total_items = total_items | plus: 1 %}{%- endif -%}
            {%- if section.settings.slide_2_enable -%}{% assign total_items = total_items | plus: 1 %}{%- endif -%}
            {%- if section.settings.slide_3_enable -%}{% assign total_items = total_items | plus: 1 %}{%- endif -%}
            
            {%- if total_items > section.settings.product_limit %}{% assign total_items = section.settings.product_limit %}{% endif %}
        {%- endif -%}

        {%- if total_items == 0 %}{% assign total_items = 6 %}{% endif %}

        {%- assign current_index = 0 -%}
        {%- assign angle_step = 360.0 | divided_by: total_items -%}

        {%- if app_data_active -%}
             <!-- Render App Dashboard Slides -->
             {%- for slide in app_slides -%}
                {%- assign angle = current_index | times: angle_step -%}
                
                {% if slide.link != blank %}
                    <a href="{{ slide.link }}" class="carousel-card-{{ section.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ section.settings.carousel_radius }}px);">
                {% else %}
                    <div class="carousel-card-{{ section.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ section.settings.carousel_radius }}px);">
                {% endif %}
                
                    <div class="card-image-{{ section.id }}">
                        {% if slide.imageUrl != blank %}
                            <img src="{{ slide.imageUrl }}" class="card-image-content" alt="{{ slide.title }}" width="400" height="300" loading="lazy">
                        {% else %}
                             {{ 'image' | placeholder_svg_tag: 'card-image-content' }}
                        {% endif %}
                    </div>
                    <div class="card-info-{{ section.id }}">
                        <strong>{{ slide.title | default: 'Slide' }}</strong>
                        <p>{{ slide.subtitle }}</p>
                    </div>
                
                {% if slide.link != blank %}
                    </a>
                {% else %}
                    </div>
                {% endif %}

                {%- assign current_index = current_index | plus: 1 -%}
             {%- endfor -%}
        
        {%- else -%}
            <!-- Render Custom Slides First -->
            {%- for i in (1..3) -%}
                {%- capture enable_key -%}slide_{{i}}_enable{%- endcapture -%}
                {%- if section.settings[enable_key] -%}
                    {%- capture image_key -%}slide_{{i}}_image{%- endcapture -%}
                    {%- capture link_key -%}slide_{{i}}_link{%- endcapture -%}
                    
                    {%- assign custom_image = section.settings[image_key] -%}
                    {%- assign custom_link = section.settings[link_key] -%}

                    {%- assign angle = current_index | times: angle_step -%}
                    
                    {% if custom_link != blank %}
                        <a href="{{ custom_link }}" class="carousel-card-{{ section.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ section.settings.carousel_radius }}px);">
                    {% else %}
                        <div class="carousel-card-{{ section.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ section.settings.carousel_radius }}px);">
                    {% endif %}
                    
                        <div class="card-image-{{ section.id }}">
                            {% if custom_image %}
                                {{ custom_image | image_url: width: 400 | image_tag: class: 'card-image-content' }}
                            {% else %}
                                 {{ 'image' | placeholder_svg_tag: 'card-image-content' }}
                            {% endif %}
                        </div>
                        <div class="card-info-{{ section.id }}">
                            <strong>Slide {{ i }}</strong>
                            <p>Click to view</p>
                        </div>
                    
                    {% if custom_link != blank %}
                        </a>
                    {% else %}
                        </div>
                    {% endif %}

                    {%- assign current_index = current_index | plus: 1 -%}
                {%- endif -%}
            {%- endfor -%}

            <!-- Render Product List / Collection -->
            {%- if section.settings.product_list != blank -%}
                 {%- for product in section.settings.product_list limit: section.settings.product_limit -%}
                    {%- if current_index < total_items -%}
                        {%- assign angle = current_index | times: angle_step -%}
                        <a href="{{ product.url }}" class="carousel-card-{{ section.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ section.settings.carousel_radius }}px);">
                            <div class="card-image-{{ section.id }}">
                                {% if product.featured_image %}
                                    {{ product.featured_image | image_url: width: 400 | image_tag: class: 'card-image-content' }}
                                {% else %}
                                    {{ 'product-1' | placeholder_svg_tag: 'card-image-content' }}
                                {% endif %}
                            </div>
                            <div class="card-info-{{ section.id }}">
                                <strong>{{ product.title }}</strong>
                                <p>{{ product.price | money }}</p>
                            </div>
                        </a>
                        {%- assign current_index = current_index | plus: 1 -%}
                    {%- endif -%}
                 {%- endfor -%}
            {%- elsif section.settings.collection != blank -%}
                 {%- for product in section.settings.collection.products limit: section.settings.product_limit -%}
                    {%- if current_index < total_items -%}
                        {%- assign angle = current_index | times: angle_step -%}
                        <a href="{{ product.url }}" class="carousel-card-{{ section.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ section.settings.carousel_radius }}px);">
                            <div class="card-image-{{ section.id }}">
                                {% if product.featured_image %}
                                    {{ product.featured_image | image_url: width: 400 | image_tag: class: 'card-image-content' }}
                                {% else %}
                                    {{ 'product-1' | placeholder_svg_tag: 'card-image-content' }}
                                {% endif %}
                            </div>
                            <div class="card-info-{{ section.id }}">
                                <strong>{{ product.title }}</strong>
                                <p>{{ product.price | money }}</p>
                            </div>
                        </a>
                        {%- assign current_index = current_index | plus: 1 -%}
                    {%- endif -%}
                 {%- endfor -%}
            {%- endif -%}

            <!-- Fallback if nothing configured -->
            {%- if current_index == 0 -%}
                {%- for i in (1..6) -%}
                    {%- assign angle = i | minus: 1 | times: 60 -%}
                    <div class="carousel-card-{{ section.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ section.settings.carousel_radius }}px);">
                        <div class="card-image-{{ section.id }}">
                            {{ 'product-' | append: i | placeholder_svg_tag: 'card-image-content' }}
                        </div>
                        <div class="card-info-{{ section.id }}">
                            <strong>Sample Product {{ i }}</strong>
                            <p>$99.00</p>
                        </div>
                    </div>
                {%- endfor -%}
            {%- endif -%}
        {%- endif -%}

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const scene = document.getElementById('scene-{{ section.id }}');
    const autoRotate = {{ section.settings.auto_rotate }};
    const speed = 2; // Fixed speed
    let angle = 0;

    if(autoRotate) {
        setInterval(() => {
            angle -= speed * 0.1;
            scene.style.transform = `perspective(1000px) rotateY(${angle}deg)`;
        }, 20);
    }
});
</script>