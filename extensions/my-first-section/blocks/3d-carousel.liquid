{% assign rotation_direction = section.settings.rotation_direction | default: 'left' %}
{% assign pause_on_hover = section.settings.pause_on_hover | default: true %}
{% assign enable_depth_fade = section.settings.enable_depth_fade | default: true %}
{% assign text_color = section.settings.text_color | default: '#000000' %}
{% assign show_dots = section.settings.show_dots | default: false %}
{% assign show_arrows = section.settings.show_arrows | default: true %}
{% assign show_button = section.settings.show_button | default: true %}
{% assign button_text = section.settings.button_text | default: 'View' %}
{% assign show_badge = section.settings.show_badge | default: true %}

<div class="carousel-section-wrapper carousel-section-wrapper-{{ section.id }}" style="
    overflow: hidden; 
    padding: 60px 0; 
    position: relative; 
    background: transparent;
    min-height: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
    perspective: 1000px;
">
    <style>
        .carousel-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .carousel {
            position: relative;
            width: 300px;
            height: 400px;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }
        .card {
            position: absolute;
            width: 300px;
            height: 400px;
            left: 0;
            top: 0;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transition: opacity 0.3s;
            backface-visibility: hidden; /* Optimize rendering */
        }
        .card-inner-{{ section.id }} {
            width: 100%;
            height: 100%;
            background: {% if section.settings.card_style == 'glass' %}rgba(255,255,255,0.7){% else %}#ffffff{% endif %};
            {% if section.settings.card_style == 'glass' %}backdrop-filter: blur(10px);{% endif %}
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .card-image-wrapper {
            width: 100%;
            height: 60%;
            overflow: hidden;
        }
        .card-image-wrapper img, .card-image-wrapper svg {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .card-content {
            padding: 20px;
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-left { left: 20px; }
        .nav-right { right: 20px; }
        .tag {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4d4d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .btn-view {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #000;
            color: #fff;
            border-radius: 20px;
            font-size: 14px;
            text-decoration: none;
        }
        .controls {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            opacity: 0.6;
        }
    </style>
    
    <div class="carousel-container">
        {% if section.settings.heading != blank %}
            <div style="position: absolute; top: -50px; left: 0; width: 100%; text-align: center; z-index: 5;">
                <h2 style="margin: 0; font-size: 2rem; color: {{ text_color }};">{{ section.settings.heading }}</h2>
            </div>
        {% endif %}

        <div class="carousel" id="carousel-{{ section.id }}">
            {% assign items = '' %}
            {% assign use_manual = false %}
            
            {% if section.settings.product_list != blank %}
                {% assign items = section.settings.product_list %}
            {% elsif section.settings.collection != blank %}
                {% assign items = collections[section.settings.collection].products %}
            {% else %}
                {% assign use_manual = true %}
            {% endif %}

            {% if use_manual %}
                 {% comment %} Manual Slides Loop {% endcomment %}
                 {% for i in (1..5) %}
                    {% capture image_key %}slide_{{ i }}_image{% endcapture %}
                    {% capture title_key %}slide_{{ i }}_title{% endcapture %}
                    {% capture link_key %}slide_{{ i }}_link{% endcapture %}
                    {% assign image = section.settings[image_key] %}
                    {% assign title = section.settings[title_key] %}
                    {% assign url = section.settings[link_key] %}
                    
                    {% if image != blank %}
                        <div class="card card-{{ section.id }}">
                            <div class="card-inner-{{ section.id }}">
                                <div class="card-image-wrapper">
                                    <img src="{{ image | image_url: width: 600 }}" alt="{{ title }}" loading="lazy" width="300" height="240">
                                </div>
                                <div class="card-content">
                                    <h3 style="color: {{ text_color }}">{{ title }}</h3>
                                    {% if show_button and url != blank %}
                                        <div class="card-actions">
                                            <span class="btn-view">{{ button_text }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                {% if url != blank %}
                                    <a href="{{ url }}" class="card-link-overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;"></a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                 {% endfor %}
            {% else %}
                {% for item in items limit: section.settings.product_limit %}
                    {% assign title = item.title %}
                    {% assign price = item.price | money %}
                    {% assign image = item.featured_image %}
                    {% assign url = item.url %}
                    {% assign badge = '' %}
                    {% if item.compare_at_price > item.price %}{% assign badge = 'Sale' %}{% endif %}

                    <div class="card card-{{ section.id }}">
                        <div class="card-inner-{{ section.id }}">
                            <div class="card-image-wrapper">
                                {% if image != blank %}
                                    <img src="{{ image | image_url: width: 600 }}" alt="{{ title }}" loading="lazy" width="300" height="240">
                                {% else %}
                                    {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                                {% endif %}
                            </div>
                            <div class="card-content">
                                {% if show_badge and badge != blank %}
                                    <span class="tag">{{ badge }}</span>
                                {% endif %}
                                <h3 style="color: {{ text_color }}">{{ title }}</h3>
                                <div class="price" style="color: {{ text_color }}">{{ price }}</div>
                                {% if show_button %}
                                    <div class="card-actions">
                                        <span class="btn-view">{{ button_text }}</span>
                                    </div>
                                {% endif %}
                            </div>
                            <a href="{{ url }}" class="card-link-overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;"></a>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
    
    {% if show_arrows %}
        <button class="nav-btn nav-btn-{{ section.id }} nav-left" aria-label="Rotate Left">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <button class="nav-btn nav-btn-{{ section.id }} nav-right" aria-label="Rotate Right">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>
    {% endif %}

    <div class="controls" style="color: {{ text_color }}">
        <p>Drag, Scroll or Use Arrows</p>
    </div>
</div>

<script>
    (function() {
        const sectionId = "{{ section.id }}";
        const wrapper = document.querySelector(`.carousel-section-wrapper-${sectionId}`);
        const carousel = wrapper.querySelector(`#carousel-${sectionId}`);
        const cards = Array.from(carousel.querySelectorAll(`.card-${sectionId}`));
        const navLeft = wrapper.querySelector(`.nav-btn-${sectionId}.nav-left`);
        const navRight = wrapper.querySelector(`.nav-btn-${sectionId}.nav-right`);
        
        if (cards.length === 0) return;

        const radius = 400; // Distance from center
        const angleIncrement = 360 / cards.length;
        let currentAngle = 0;
        let targetAngle = 0;
        let isDragging = false;
        let startX = 0;
        let lastX = 0;
        let velocity = 0;
        let animationId;
        let isInteracting = false;
        
        // Settings
        const autoRotate = true;
        const autoRotateSpeed = "{{ rotation_direction }}" === 'left' ? 0.2 : -0.2;
        const pauseOnHover = {{ pause_on_hover }};
        
        function animate() {
            if (!isDragging) {
                velocity *= 0.95; // Friction
                if (Math.abs(velocity) < 0.001) velocity = 0;
                
                if (velocity === 0 && autoRotate && !isInteracting) {
                    targetAngle += autoRotateSpeed;
                } else {
                    targetAngle += velocity;
                }
            }
            
            currentAngle += (targetAngle - currentAngle) * 0.1;
            carousel.style.transform = `rotateY(${currentAngle}deg)`;
            
            cards.forEach((card, i) => {
                 const cardAngle = i * angleIncrement;
                 card.style.transform = `rotateY(${cardAngle}deg) translateZ(${radius}px)`;
                 
                 let absoluteAngle = (cardAngle + currentAngle) % 360;
                 if (absoluteAngle < 0) absoluteAngle += 360;
                 
                 // z-index logic
                 let distFromFront = Math.min(absoluteAngle, 360 - absoluteAngle);
                 card.style.zIndex = 1000 - Math.round(distFromFront);
                 
                 if ({{ enable_depth_fade }}) {
                    let opacity = 1 - (distFromFront / 180);
                    if (opacity < 0.2) opacity = 0.2;
                    card.style.opacity = opacity;
                 }
            });
            
            animationId = requestAnimationFrame(animate);
        }
        
        animate();

        // Interaction
        const onMouseDown = (e) => {
            isDragging = true;
            isInteracting = true;
            startX = e.clientX;
            lastX = e.clientX;
            wrapper.style.cursor = "grabbing";
        };
        
        const onMouseMove = (e) => {
            if (!isDragging) return;
            const x = e.clientX;
            const delta = x - lastX;
            targetAngle += delta * 0.5;
            velocity = delta * 0.5;
            lastX = x;
        };
        
        const onMouseUp = () => {
            isDragging = false;
            wrapper.style.cursor = "grab";
            setTimeout(() => isInteracting = false, 1000);
        };

        wrapper.addEventListener('mousedown', onMouseDown);
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
        
        // Touch support
        wrapper.addEventListener('touchstart', (e) => {
            isDragging = true;
            isInteracting = true;
            lastX = e.touches[0].clientX;
        });
        wrapper.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const x = e.touches[0].clientX;
            const delta = x - lastX;
            targetAngle += delta * 0.5;
            velocity = delta * 0.5;
            lastX = x;
        });
        wrapper.addEventListener('touchend', () => {
            isDragging = false;
            setTimeout(() => isInteracting = false, 1000);
        });
        
        if (navLeft) navLeft.addEventListener('click', () => {
            targetAngle += angleIncrement;
            isInteracting = true;
            setTimeout(() => isInteracting = false, 1000);
        });
        
        if (navRight) navRight.addEventListener('click', () => {
            targetAngle -= angleIncrement;
            isInteracting = true;
            setTimeout(() => isInteracting = false, 1000);
        });
        
        if (pauseOnHover) {
            wrapper.addEventListener('mouseenter', () => isInteracting = true);
            wrapper.addEventListener('mouseleave', () => isInteracting = false);
        }
    })();
</script>

{% schema %}
{
  "name": "3D Carousel Pro",
  "target": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Data Source"
    },
    {
      "type": "product_list",
      "id": "product_list",
      "label": "Product List",
      "limit": 20
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "product_limit",
      "min": 5,
      "max": 30,
      "step": 1,
      "label": "Max Products",
      "default": 10
    },
    {
      "type": "header",
      "content": "Manual Slides (Fallback)"
    },
    {
      "type": "image_picker",
      "id": "slide_1_image",
      "label": "Slide 1 Image"
    },
    {
      "type": "text",
      "id": "slide_1_title",
      "label": "Slide 1 Title"
    },
    {
      "type": "url",
      "id": "slide_1_link",
      "label": "Slide 1 Link"
    },
    {
      "type": "image_picker",
      "id": "slide_2_image",
      "label": "Slide 2 Image"
    },
    {
      "type": "text",
      "id": "slide_2_title",
      "label": "Slide 2 Title"
    },
    {
      "type": "url",
      "id": "slide_2_link",
      "label": "Slide 2 Link"
    },
    {
      "type": "image_picker",
      "id": "slide_3_image",
      "label": "Slide 3 Image"
    },
    {
      "type": "text",
      "id": "slide_3_title",
      "label": "Slide 3 Title"
    },
    {
      "type": "url",
      "id": "slide_3_link",
      "label": "Slide 3 Link"
    },
    {
      "type": "image_picker",
      "id": "slide_4_image",
      "label": "Slide 4 Image"
    },
    {
      "type": "text",
      "id": "slide_4_title",
      "label": "Slide 4 Title"
    },
    {
      "type": "url",
      "id": "slide_4_link",
      "label": "Slide 4 Link"
    },
    {
      "type": "image_picker",
      "id": "slide_5_image",
      "label": "Slide 5 Image"
    },
    {
      "type": "text",
      "id": "slide_5_title",
      "label": "Slide 5 Title"
    },
    {
      "type": "url",
      "id": "slide_5_link",
      "label": "Slide 5 Link"
    },
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Collection"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "card_style",
      "label": "Card Style",
      "options": [
        {
          "value": "default",
          "label": "Default"
        },
        {
          "value": "glass",
          "label": "Glass Effect"
        }
      ],
      "default": "default"
    },
    {
      "type": "select",
      "id": "rotation_direction",
      "label": "Rotation Direction",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "label": "Pause on Hover",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_depth_fade",
      "label": "Enable Depth Fade",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_button",
      "label": "Show View Button",
      "default": true
    }
  ]
}
{% endschema %}