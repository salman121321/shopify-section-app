{% schema %}
{
  "name": "3D Carousel Pro",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Data Source"
    },
    {
      "type": "product_list",
      "id": "product_list",
      "label": "Product List",
      "limit": 12
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "product_limit",
      "min": 5,
      "max": 20,
      "step": 1,
      "label": "Max Products",
      "default": 10
    },
    {
      "type": "header",
      "content": "Section Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Products"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Subheading",
      "default": "<p>Check out our latest collection</p>"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "label": "Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Colors & Style"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#a3d5f7"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "subheading_color",
      "label": "Text Color",
      "default": "#4a4a4a"
    },
    {
        "type": "color",
        "id": "card_bg_color",
        "label": "Card Background",
        "default": "#ffffff"
    },
    {
        "type": "color",
        "id": "text_color",
        "label": "Card Title Color",
        "default": "#1a1a1a"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full Width",
      "default": true
    },
    {
      "type": "range",
      "id": "section_height",
      "min": 400,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Height",
      "default": 600
    },
    {
      "type": "range",
      "id": "carousel_radius",
      "min": 200,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Carousel Radius",
      "default": 450
    },
    {
      "type": "select",
      "id": "card_style",
      "label": "Card Style",
      "options": [
        { "value": "solid", "label": "Solid" },
        { "value": "glass", "label": "Glassmorphism" },
        { "value": "outlined", "label": "Outlined" }
      ],
      "default": "solid"
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Auto Rotate",
      "default": true
    },
    {
      "type": "range",
      "id": "auto_rotate_speed",
      "min": 0,
      "max": 10,
      "step": 1,
      "label": "Speed",
      "default": 2
    }
  ]
}
{% endschema %}

{%- style -%}
    .carousel-section-wrapper-{{ block.id }} {
        background-color: {{ block.settings.background_color }};
        height: {{ block.settings.section_height }}px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .carousel-content-{{ block.id }} {
        text-align: {{ block.settings.header_alignment }};
        z-index: 2;
        margin-bottom: 20px;
        position: absolute;
        top: 20px;
        width: 100%;
        max-width: 1200px;
        padding: 0 20px;
    }

    .carousel-heading-{{ block.id }} {
        color: {{ block.settings.heading_color }};
        font-size: 32px;
        margin: 0 0 10px 0;
    }

    .carousel-subheading-{{ block.id }} {
        color: {{ block.settings.subheading_color }};
        font-size: 16px;
        margin: 0;
    }

    .carousel-scene-{{ block.id }} {
        perspective: 1000px;
        width: 280px;
        height: 400px;
        position: relative;
        transform-style: preserve-3d;
    }

    .carousel-card-{{ block.id }} {
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        border-radius: 16px;
        background: {{ block.settings.card_bg_color }};
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: transform 0.5s;
        
        {% if block.settings.card_style == 'glass' %}
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        {% elsif block.settings.card_style == 'outlined' %}
            background: transparent;
            border: 2px solid {{ block.settings.heading_color }};
        {% endif %}
    }

    .card-image-{{ block.id }} {
        width: 100%;
        height: 60%;
        object-fit: cover;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    
    .card-image-content {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .card-info-{{ block.id }} {
        padding: 15px;
        text-align: center;
        color: {{ block.settings.text_color }};
    }
{%- endstyle -%}

<div class="carousel-section-wrapper-{{ block.id }}">
    <div class="carousel-content-{{ block.id }}">
        {% if block.settings.heading != blank %}
            <h2 class="carousel-heading-{{ block.id }}">{{ block.settings.heading }}</h2>
        {% endif %}
        {% if block.settings.subheading != blank %}
            <div class="carousel-subheading-{{ block.id }}">{{ block.settings.subheading }}</div>
        {% endif %}
    </div>

    <div class="carousel-scene-{{ block.id }}" id="scene-{{ block.id }}">
        {%- assign product_limit = block.settings.product_limit -%}
        
        {%- if block.settings.product_list != blank -%}
            {%- assign total_items = block.settings.product_list.count -%}
            {%- if total_items > product_limit -%}
                {%- assign total_items = product_limit -%}
            {%- endif -%}
            
            {%- for product in block.settings.product_list limit: product_limit -%}
                {%- assign angle_step = 360.0 | divided_by: total_items -%}
                {%- assign angle = forloop.index0 | times: angle_step -%}
                
                <div class="carousel-card-{{ block.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ block.settings.carousel_radius }}px);">
                    <div class="card-image-{{ block.id }}">
                        {% if product.featured_image %}
                            {{ product.featured_image | image_url: width: 400 | image_tag: class: 'card-image-content' }}
                        {% else %}
                             {{ 'product-1' | placeholder_svg_tag: 'card-image-content' }}
                        {% endif %}
                    </div>
                    <div class="card-info-{{ block.id }}">
                        <strong>{{ product.title }}</strong>
                        <p>{{ product.price | money }}</p>
                    </div>
                </div>
            {%- endfor -%}
            
        {%- elsif block.settings.collection != blank -%}
             {%- assign total_items = block.settings.collection.products_count -%}
             {%- if total_items > product_limit -%}
                {%- assign total_items = product_limit -%}
             {%- endif -%}
             {%- if total_items == 0 %}{% assign total_items = 6 %}{% endif %}

            {%- for product in block.settings.collection.products limit: product_limit -%}
                {%- assign angle_step = 360.0 | divided_by: total_items -%}
                {%- assign angle = forloop.index0 | times: angle_step -%}

                <div class="carousel-card-{{ block.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ block.settings.carousel_radius }}px);">
                    <div class="card-image-{{ block.id }}">
                        {% if product.featured_image %}
                            {{ product.featured_image | image_url: width: 400 | image_tag: class: 'card-image-content' }}
                        {% else %}
                             {{ 'product-1' | placeholder_svg_tag: 'card-image-content' }}
                        {% endif %}
                    </div>
                    <div class="card-info-{{ block.id }}">
                        <strong>{{ product.title }}</strong>
                        <p>{{ product.price | money }}</p>
                    </div>
                </div>
            {%- endfor -%}
        {%- else -%}
            <!-- Fallback Mock Cards -->
            {%- assign total_items = 6 -%}
            {%- for i in (1..6) -%}
                {%- assign angle = i | minus: 1 | times: 60 -%}
                <div class="carousel-card-{{ block.id }}" style="transform: rotateY({{ angle }}deg) translateZ({{ block.settings.carousel_radius }}px);">
                    <div class="card-image-{{ block.id }}">
                        {{ 'product-' | append: i | placeholder_svg_tag: 'card-image-content' }}
                    </div>
                    <div class="card-info-{{ block.id }}">
                        <strong>Sample Product {{ i }}</strong>
                        <p>$99.00</p>
                    </div>
                </div>
            {%- endfor -%}
        {%- endif -%}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const scene = document.getElementById('scene-{{ block.id }}');
    const radius = {{ block.settings.carousel_radius }};
    const autoRotate = {{ block.settings.auto_rotate }};
    const speed = {{ block.settings.auto_rotate_speed }};
    let angle = 0;

    if(autoRotate && speed > 0) {
        setInterval(() => {
            angle -= speed * 0.1;
            scene.style.transform = `perspective(1000px) rotateY(${angle}deg)`;
        }, 20);
    }
});
</script>
